name: deployment

on:
  push:
    branches: [ "CU-86cvcxan9_build-Docker-images_Sumit" ]
    
  pull_request:
    branches: [ "CU-86cvcxan9_build-Docker-images_Sumit" ]

jobs:

  # Docker_build: 

  #   runs-on: label-2 #groot #runner
  #   steps:
  #   - uses: actions/checkout@v3
  #   - name: Print the workflow run ID
  #     run: echo "Workflow run ID:${{ github.run_id }}"
  #   # - name: Remove older images
  #   #   run: |
  #   #     sudo docker rmi -f wanderlust_backend:latest wanderlust_frontend:latest
        
  #   - name: Build Image
  #     run: |
  #       cd /home/ubuntu/actions-runner/_work/wanderlust/wanderlust/backend
  #       sudo docker build -t wanderlust_backend:latest .
  #       cd /home/ubuntu/actions-runner/_work/wanderlust/wanderlust/frontend
  #       sudo docker build -t wanderlust_frontend:latest .
        
  build_push_image:
    runs-on: groot #runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      # - name: Login to Docker Hub
      #   uses: docker/login-action@v2
      #   with:
      #     username: ${{ secrets.DOCKER_HUB_USERNAME }}
      #     password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          
      - name: Build Image
        run: |
          sudo docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" -p "${{ secrets.DOCKER_HUB_PASSWORD }}"
          
          cd /home/ubuntu/actions-runner/_work/wanderlust/wanderlust/backend
          sudo docker build -t wanderlust_backend:latest .
          sudo docker tag wanderlust_backend:latest ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_backend:latest
          sudo docker push sumitramchandra/wanderlust_backend:latest
          
          cd /home/ubuntu/actions-runner/_work/wanderlust/wanderlust/frontend
          sudo docker build -t wanderlust_frontend:latest .
          sudo docker tag wanderlust_frontend:latest ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_frontend:latest
          sudo docker push ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_frontend:latest
          

      # - name: Build and push frontend Docker image
      #   uses: docker/build-push-action@v2
      #   with:
      #     context: .
      #     file: /home/ubuntu/actions-runner/_work/wanderlust/wanderlust/frontend/Dockerfile
      #     push: true
      #     tags: ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_frontend:latest

      # - name: Build and push backend Docker image
      #   uses: docker/build-push-action@v2
      #   with:
      #     context: .
      #     file: /home/ubuntu/actions-runner/_work/wanderlust/wanderlust/backend/Dockerfile
      #     push: true
      #     tags: ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_backend:latest

  Deployment: 

    runs-on: label-2 #groot #runner
    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js
      uses: actions/setup-node@v3

    - name: print the directory path and file content
      run: |
        pwd
        git branch -a
        git checkout devsecops
        ls -a

    - name: run the containers on deployment server
      run: |
          sudo docker-compose down
          sudo docker-compose up -d --build
          sudo docker ps
          sudo docker exec mongo mongoimport --db wanderlust --collection posts --file ./data/sample_posts.json --jsonArray
          
    # - name: install frontend dependencies
    #   run: cd frontend && npm i 
    
    # - name: copy uri to .env #change the path
    #   run: cp /home/fs-lp-56/actions-runner/_work/wanderlust/wanderlust/backend/.env.sample .env.local
    
    # - name: start frontend
    #   run: |
    #       cd frontend && nohup npm run dev -- --host &
    
    # - name: install backend dependencies
    #   run: cd backend && npm i 
      
    # - name: copy uri to .env #change the path
    #   run: cp /home/fs-lp-56/actions-runner/_work/wanderlust/wanderlust/backend/.env.sample .env
    
    # - name: start backend server
    #   run: |
    #       # (cd backend && npm start > server.log 2>&1 &)
    #       cd backend && npm start
