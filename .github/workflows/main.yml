name: deployment

on:
  push:
    branches: 
      - CU-86cvfpzcf_versioning
    
  pull_request:
    branches: 
      - CU-86cvfpzcf_versioning

jobs:
  build_push_image:
    runs-on: label-2 #runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set the TAG environment variable
        run: echo "TAG=${GITHUB_RUN_ID}" >> $GITHUB_ENV

      - name: Build and Push Backend Image
        run: |
          docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" -p "${{ secrets.DOCKER_HUB_PASSWORD }}"
          cd backend
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_backend:${{ env.TAG }} .
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_backend:${{ env.TAG }}

      - name: Build and Push Frontend Image
        run: |
          cd frontend
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_frontend:${{ env.TAG }} .
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_frontend:${{ env.TAG }}
          
  deployment: 
    runs-on: label-2 #runner
    needs: [build_push_image]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3

      - name: Print the directory path and file content
        run: |
          pwd
          git branch -a
          git checkout devsecops
          ls -a

      - name: Run the containers on deployment server
        run: |
          export TAG=${{ needs.build_push_image.outputs.TAG }}
          sudo docker-compose down
          sudo docker rmi ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_backend:latest
          sudo docker rmi ${{ secrets.DOCKER_HUB_USERNAME }}/wanderlust_frontend:latest
          sudo docker-compose up -d --build
          sudo docker ps
          sudo docker exec mongo mongoimport --db wanderlust --collection posts --file ./data/sample_posts.json --jsonArray
      
          
    # - name: install frontend dependencies
    #   run: cd frontend && npm i 
    
    # - name: copy uri to .env #change the path
    #   run: cp /home/fs-lp-56/actions-runner/_work/wanderlust/wanderlust/backend/.env.sample .env.local
    
    # - name: start frontend
    #   run: |
    #       cd frontend && nohup npm run dev -- --host &
    
    # - name: install backend dependencies
    #   run: cd backend && npm i 
      
    # - name: copy uri to .env #change the path
    #   run: cp /home/fs-lp-56/actions-runner/_work/wanderlust/wanderlust/backend/.env.sample .env
    
    # - name: start backend server
    #   run: |
    #       # (cd backend && npm start > server.log 2>&1 &)
    #       cd backend && npm start
